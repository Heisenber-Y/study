<?xml version="1.0" encoding="UTF-8"?>
<!-- app层增量数据清洗 -->
<!-- 
  提交时替换参数说明:
  ${DATE}: 增量数据日期
  ${PIPE_LOG_FILE}:       pipe日志
  ${HDFS_WORKDIR}:        pipe工作目录(HDFS)
  ${HDFS_BASE_PATH}:      HDFS基础路径
  ${PIPE_EXTERNAL_PATH}:  本地pipe meta及sql文件存放路径
-->
<configuration>
	<pipe logpath="${PIPE_LOG_FILE}" sparkconf="spark.driver.maxResultSize=2g," workdir="${HDFS_WORKDIR}"/>
	<!-- spark UDF function register -->
	<register type="call" class="com.cpic.lifeinsurance.utils.IDInfo.IDUtils" />
	<register type="call" class="com.cpic.loader.pipe.SQLRegister.RegisterBuildInUDFs" />
	<register type="call" class="com.cpic.loader.pipe.SQLRegister.RegisterBuildInUDAFs" />
	<register type="call" class="com.cpic.propertyinsurance.accident.VINInfo.VINUtils" />
	<!--Hadoop Security-->
	<!--<security userPrincipal="admin" userKeytabPath="/opt/client/adminKeyTab/user.keytab" krb5ConfPath="/opt/client/adminKeyTab/krb5.conf" />-->

	<!-- 从Base层获取表数据  -->
	<sources>
		 <source table_name="AL_CF_RP_ADJUSTMENTINFO_INCREMENT" type="parquet" path="${HDFS_BASE_PATH}/filter/jack_filter_adjustmentinfo" print="2"/>
		 <source table_name="AL_CF_IDX_CASEFOLDER_INCREMENT" type="parquet" path="${HDFS_BASE_PATH}/filter/jack_filter_case/" print="2"/>
		 <source table_name="AL_CF_RP_GARAGE_INCREMENT" type="parquet" path="${HDFS_BASE_PATH}/filter/jack_filter_garage/" print="2"/>
		 <source table_name="AL_CF_RP_ACCIDENTVEHICLE_INCREMENT" type="parquet" path="${HDFS_BASE_PATH}/filter/jack_filter_accidentvehicle/" print="2"/>
		 <source table_name="AL_CF_RP_VEHICLECONDITION_INCREMENT" type="parquet" path="${HDFS_BASE_PATH}/filter/jack_filter_vehiclecondition/" print="2"/>
		 <source table_name="AL_CF_RP_RELATEDPERSONNEL_INCREMENT" type="parquet" path="${HDFS_BASE_PATH}/filter/jack_filter_relatedpersonnel/" print="2"/>
		 <source table_name="AL_CF_RP_INSURANCEPRODUCT_INCREMENT" type="parquet" path="${HDFS_BASE_PATH}/filter/jack_filter_insurance/" print="2"/>
		 <source table_name="AL_T_EMPLOYEE_VIEW_INCREMENT" type="parquet" path="${HDFS_BASE_PATH}/filter/jack_filter_employee/" print="2"/>
		 <source table_name="AL_CF_RP_SETTLEMENTACCOUNT_INCREMENT" type="parquet" path="${HDFS_BASE_PATH}/filter/jack_filter_settmentaccount/" print="2"/>
		 <source table_name="AL_CF_RP_VEHICLEASSESSMENT_INCREMENT" type="parquet" path="${HDFS_BASE_PATH}/filter/jack_filter_vehicleassessment/" print="2"/>
		 <source table_name="AL_CF_RP_PROPERTYSURVEYREPORT_INCREMENT" type="parquet" path="${HDFS_BASE_PATH}/filter/jack_filter_propertysurveyreport/" print="2"/>
		 <source table_name="AL_CF_RP_ORGANIZATION_INCREMENT" type="parquet" path="${HDFS_BASE_PATH}/filter/jack_filter_organization/" print="2"/>
		 <!-- 20170526：修改维度表为dim_code，新增对ACCIDENTCAUSE、CERTIFICATETYPE、PAYEETYPE、PROVINCEOFPAYEEACCOUNT、CITYOFPAYEEACCOUNT这五个字段的代码解释 -->
		 <source table_name="AL_CF_RP_DIM_CODE_INCREMENT" type="parquet" path="${HDFS_BASE_PATH}/filter/jack_filter_dim_code/" print="2"/>
		 <source table_name="AL_CF_RP_NOTIFICATION_INCREMENT" type="parquet" path="${HDFS_BASE_PATH}/filter/jack_filter_notification/" print="2"/>
	</sources>

	<transforms>
		<!--******************************** 增量数据，根据原表主键先去重 start *********************************-->
		<!-- 1.AL_CF_RP_ADJUSTMENTINFO(理算书表)，根据主键ACTUALID去重 -->
		<transform table_name="AL_CF_RP_ADJUSTMENTINFO" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT
			  t.ACTUALID,
				t.TOPACTUALID,
				t.PARENTACTUALKIND,
				t.KIND,
				t.ADJUSTMENTNOOFCTP,
				t.TOTALCTPPAYMENT,
				t.STATUSOFCTPADJUSTMENT,
				t.ADJUSTMENTNOOFCOMMERCIAL,
				t.TOTALCOMMERCIALPAYMENT,
				t.STATUSOFCOMMERCIALADJUSTMENT,
				t.ACTUALPAYMENTOFFDEDUCTIBLE,
				t.VERSIONTAG
				,INCREASE_DATE --增量日期:20170515 ADD BY HB
			FROM
			(
				SELECT
					ACTUALID,
					TOPACTUALID,
					PARENTACTUALKIND,
					KIND,
					ADJUSTMENTNOOFCTP,
					TOTALCTPPAYMENT,
					STATUSOFCTPADJUSTMENT,
					ADJUSTMENTNOOFCOMMERCIAL,
					TOTALCOMMERCIALPAYMENT,
					STATUSOFCOMMERCIALADJUSTMENT,
					ACTUALPAYMENTOFFDEDUCTIBLE,
					VERSIONTAG,
					INCREASE_DATE, --增量日期:20170515 ADD BY HB
					--获取最新一条有效数据
					row_number() over(partition by ACTUALID order by AL_POPULATION_TIMESTAMP desc,INCREASE_DATE asc) rank
				FROM AL_CF_RP_ADJUSTMENTINFO_INCREMENT
			) t WHERE t.rank = 1
			]]>                            
		</transform>
		
		<!-- 2. AL_CF_IDX_CASEFOLDER(案件信息表) ，根据主键CASEFOLDERID去重 -->
		<transform table_name="AL_CF_IDX_CASEFOLDER" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT
			  t.CASEFOLDERID,
			  t.NOTIFICATIONNO,
			  t.NOTIFICATIONDATE,
			  t.NOTIFICATIONTEL,
			  t.BRANCH_CODE,
			  t.ACCIDENTCAUSE,
			  t.ACCIDENTDATE,
			  t.ACCIDENTLOCATION,
			  t.CTPCLAIMNO,
			  t.CTPSTATUS,
			  t.CLAIMNO,
			  t.STATUS,
			  t.ACCIDENTBRANCH,
			  t.ISINJURYINVOLVED
			  ,INCREASE_DATE --增量日期:20170515 ADD BY HB
			FROM
			(
			  SELECT
					CASEFOLDERID,
					NOTIFICATIONNO,
					NOTIFICATIONDATE,
					NOTIFICATIONTEL,
					BRANCH_CODE,
					ACCIDENTCAUSE,
					ACCIDENTDATE,
					ACCIDENTLOCATION,
					CTPCLAIMNO,
					CTPSTATUS,
					CLAIMNO,
					STATUS,
					ACCIDENTBRANCH,
					ISINJURYINVOLVED,
					INCREASE_DATE, --增量日期:20170515 ADD BY HB
					--获取最新一条有效数据
					row_number() over(partition by CASEFOLDERID order by AL_POPULATION_TIMESTAMP desc,INCREASE_DATE asc) rank
				FROM AL_CF_IDX_CASEFOLDER_INCREMENT
			) t WHERE t.rank = 1
			]]>                                    
		</transform>

		<!-- 3. AL_CF_RP_GARAGE(维修厂信息表)，根据主键ACTUALID去重 -->
		<transform table_name="AL_CF_RP_GARAGE" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT
			  t.ACTUALID,
			  t.PARENTACTUALID,
			  t.TOPACTUALID,
			  t.PARENTACTUALKIND,
			  t.KIND,
			  t.GARAGE_CODE,
			  t.GARAGE_NAME
			  ,INCREASE_DATE --增量日期:20170515 ADD BY HB
			FROM
			(
				SELECT
					ACTUALID,
					PARENTACTUALID,
					TOPACTUALID,
					PARENTACTUALKIND,
					KIND,
					GARAGE_CODE,
					GARAGE_NAME,
					INCREASE_DATE, --增量日期:20170515 ADD BY HB
					--获取最新一条有效数据
					row_number() over(partition by ACTUALID order by AL_POPULATION_TIMESTAMP desc,INCREASE_DATE asc) rank
				FROM AL_CF_RP_GARAGE_INCREMENT
			) t WHERE t.rank = 1
			]]>
		</transform>

		<!-- 4. AL_CF_RP_ACCIDENTVEHICLE(车辆信息表)，根据主键ACTUALID去重 -->
		<transform table_name="AL_CF_RP_ACCIDENTVEHICLE" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT
			 t.ACTUALID,
			 t.PARENTACTUALID,
			 t.TOPACTUALID,
			 t.PARENTACTUALKIND,
			 t.KIND,
			 t.VIN,
			 t.PLATENO,
			 t.VEHICLEREGISTERDATE,
			 t.PURCHASEPRICE,
			 t.MOLDNAME,
			 t.VEHICLEGROUPNAME,
			 t.BRANDNAME,
			 t.ACCIDENTVEHICLELOCATION,
			 t.ENGINENO,
			 t.CREATEDATE
			 ,INCREASE_DATE --增量日期:20170515 ADD BY HB
			FROM
			(
				SELECT
					ACTUALID,
					PARENTACTUALID,
					TOPACTUALID,
					PARENTACTUALKIND,
					KIND,
					VIN,
					PLATENO,
					VEHICLEREGISTERDATE,
					PURCHASEPRICE,
					MOLDNAME,
					VEHICLEGROUPNAME,
					BRANDNAME,
					ACCIDENTVEHICLELOCATION,
					ENGINENO,
					CREATEDATE,
					INCREASE_DATE, --增量日期:20170515 ADD BY HB
					--获取最新一条有效数据
					row_number() over(partition by ACTUALID order by AL_POPULATION_TIMESTAMP desc,INCREASE_DATE asc) rank
				FROM AL_CF_RP_ACCIDENTVEHICLE_INCREMENT
			) t WHERE t.rank = 1
			]]>
		</transform>

		<!-- 5. AL_CF_RP_VEHICLECONDITION(三者车信息表)，根据主键ACTUALID去重 -->
		<transform table_name="AL_CF_RP_VEHICLECONDITION" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT
				t.ACTUALID,
				t.TOPACTUALID,
				t.PARENTACTUALKIND,
				t.KIND,
				t.THIRDPARTYFLAG,
				t.LOSSASSESSMENTNEED
				,INCREASE_DATE --增量日期:20170515 ADD BY HB
			FROM
			(
				SELECT 
					ACTUALID,
					TOPACTUALID,
					PARENTACTUALKIND,
					KIND,
					THIRDPARTYFLAG,
					LOSSASSESSMENTNEED,
					INCREASE_DATE, --增量日期:20170515 ADD BY HB
					--获取最新一条有效数据
					row_number() over(partition by ACTUALID order by AL_POPULATION_TIMESTAMP desc,INCREASE_DATE asc) rank
				FROM AL_CF_RP_VEHICLECONDITION_INCREMENT
			) t WHERE t.rank = 1
			]]>
		</transform>

		<!-- 6. AL_CF_RP_RELATEDPERSONNEL(人员信息表)，根据主键ACTUALID去重 -->
		<transform table_name="AL_CF_RP_RELATEDPERSONNEL" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT
				t.ACTUALID,
				t.PARENTACTUALID,
				t.TOPACTUALID,
				t.PARENTACTUALKIND,
				t.KIND,
				t.CERTIFICATENO,
				t.CERTIFICATETYPE,
				t.NAME,
				t.TEL,
				t.EMAIL,
				t.ADDRESS,
				t.CREATEDATE
				,INCREASE_DATE --增量日期:20170515 ADD BY HB
			FROM
			(
				SELECT
					ACTUALID,
					PARENTACTUALID,
					TOPACTUALID,
					PARENTACTUALKIND,
					KIND,
					CERTIFICATENO,
					CERTIFICATETYPE,
					NAME,
					TEL,
					EMAIL,
					ADDRESS,
					CREATEDATE,
					INCREASE_DATE, --增量日期:20170515 ADD BY HB
					--获取最新一条有效数据
					row_number() over(partition by ACTUALID order by AL_POPULATION_TIMESTAMP desc,INCREASE_DATE asc) rank
				FROM AL_CF_RP_RELATEDPERSONNEL_INCREMENT
			) t WHERE t.rank = 1
			]]>
		</transform>

		<!-- 7. AL_CF_RP_INSURANCEPRODUCT(保单信息表)，根据主键ACTUALID去重 -->
		<transform table_name="AL_CF_RP_INSURANCEPRODUCT" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT
				t.ACTUALID,
				t.TOPACTUALID,
				t.PARENTACTUALKIND,
				t.KIND,
				t.POLICYNO,
				t.POLICYTYPE,
				t.EFFECTIVEDATE,
				t.EXPIREDATE,
				t.AGENTCODE,
				t.OPERATORCODE,
				t.CREATEDATE
				,INCREASE_DATE --增量日期:20170515 ADD BY HB
			FROM
			(
				SELECT
					ACTUALID,
					TOPACTUALID,
					PARENTACTUALKIND,
					KIND,
					POLICYNO,
					POLICYTYPE,
					EFFECTIVEDATE,
					EXPIREDATE,
					AGENTCODE,
					OPERATORCODE,
					CREATEDATE,
					INCREASE_DATE, --增量日期:20170515 ADD BY HB
					--获取最新一条有效数据
					row_number() over(partition by ACTUALID order by AL_POPULATION_TIMESTAMP desc,INCREASE_DATE asc) rank
				FROM AL_CF_RP_INSURANCEPRODUCT_INCREMENT
			) t WHERE t.rank = 1
			]]>
		</transform>

		<!-- 8. AL_T_EMPLOYEE_VIEW(员工信息表) -->
		<transform table_name="AL_T_EMPLOYEE_VIEW" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT
				t.CODE,
				t.OPERATORNAME,
				t.UNIT_CODE,
				t.AGENTNAME,
				t.INCREASE_DATE --增量日期:20170515 ADD BY HB
			FROM
			(
				SELECT
					CODE,
					OPERATORNAME,
					UNIT_CODE,
					AGENTNAME,
					INCREASE_DATE, --增量日期:20170515 ADD BY HB
					--获取最新一条有效数据
					row_number() over(partition by CODE, UNIT_CODE order by APPTIME desc) rank
				FROM AL_T_EMPLOYEE_VIEW_INCREMENT
			) t WHERE t.rank = 1
			]]>
		</transform>

		<!-- 9. AL_CF_RP_SETTLEMENTACCOUNT(支付账号信息表)，根据主键ACTUALID去重 -->
		<transform table_name="AL_CF_RP_SETTLEMENTACCOUNT" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT
				t.ACTUALID,
				t.TOPACTUALID,
				t.PARENTACTUALKIND,
				t.KIND,
				t.ACCOUNTNO,
				t.PAYEEACCOUNTNAME,
				t.TIMEOFCOMMERCIALPAYMENT,
				t.TIMEOFCTPPAYMENT,
				t.ACCOUNTAMOUNT,
				t.CERTIFICATETYPE,
				t.CERTIFICATENO,
				t.PAYMENTMODE,
				t.PAYEETYPE,
				t.PROVINCEOFPAYEEACCOUNT,
				t.CITYOFPAYEEACCOUNT,
				t.NAMEOFBANK,
				t.NAMEOFHEADBANK,
				t.CTPACTUALAMOUNT,
				t.COMMERCIALACTUALAMOUNT,
				t.MEMO,
				t.CREATEDATE
				,INCREASE_DATE --增量日期:20170515 ADD BY HB
			FROM
			(
				SELECT
					ACTUALID,
					TOPACTUALID,
					PARENTACTUALKIND,
					KIND,
					ACCOUNTNO,
					PAYEEACCOUNTNAME,
					TIMEOFCOMMERCIALPAYMENT,
					TIMEOFCTPPAYMENT,
					ACCOUNTAMOUNT,
					CERTIFICATETYPE,
					CERTIFICATENO,
					PAYMENTMODE,
					PAYEETYPE,
					PROVINCEOFPAYEEACCOUNT,
					CITYOFPAYEEACCOUNT,
					NAMEOFBANK,
					NAMEOFHEADBANK,
					CTPACTUALAMOUNT,
					COMMERCIALACTUALAMOUNT,
					MEMO,
					CREATEDATE,
					INCREASE_DATE, --增量日期:20170515 ADD BY HB
					--获取最新一条有效数据
					row_number() over(partition by ACTUALID order by AL_POPULATION_TIMESTAMP desc,INCREASE_DATE asc) rank
				FROM AL_CF_RP_SETTLEMENTACCOUNT_INCREMENT
			) t WHERE t.rank = 1
			]]>
		</transform>

		<!-- 10. AL_CF_RP_VEHICLEASSESSMENT(车损估单表)，根据主键ACTUALID去重 -->
		<transform table_name="AL_CF_RP_VEHICLEASSESSMENT" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT
			  t.ACTUALID,
				t.PARENTACTUALID,
				t.TOPACTUALID,
				t.PARENTACTUALKIND,
				t.KIND,
				t.ASSESSMENTSTAFF,
				t.ASSESSMENTSTAFFBRANCH
				,INCREASE_DATE --增量日期:20170515 ADD BY HB
			FROM
			(
				SELECT
					ACTUALID,
					PARENTACTUALID,
					TOPACTUALID,
					PARENTACTUALKIND,
					KIND,
					ASSESSMENTSTAFF,
					ASSESSMENTSTAFFBRANCH,
					INCREASE_DATE, --增量日期:20170515 ADD BY HB
					--获取最新一条有效数据
					row_number() over(partition by ACTUALID order by AL_POPULATION_TIMESTAMP desc,INCREASE_DATE asc) rank
				FROM AL_CF_RP_VEHICLEASSESSMENT_INCREMENT
			) t WHERE t.rank = 1
			]]>
		</transform>

		<!-- 11. AL_CF_RP_PROPERTYSURVEYREPORT(车物查勘报告表)，根据主键ACTUALID去重 -->
		<transform table_name="AL_CF_RP_PROPERTYSURVEYREPORT" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT
				t.ACTUALID,
				t.TOPACTUALID,
				t.PARENTACTUALKIND,
				t.KIND,
				t.FIRSTSURVEYOR,
				t.FIRSTSURVEYORBRANCH,
				t.SECONDSURVEYOR,
				t.SECONDSURVEYORBRANCH
				,INCREASE_DATE --增量日期:20170515 ADD BY HB
			FROM
			(
				SELECT
					ACTUALID,
					TOPACTUALID,
					PARENTACTUALKIND,
					KIND,
					FIRSTSURVEYOR,
					FIRSTSURVEYORBRANCH,
					SECONDSURVEYOR,
					SECONDSURVEYORBRANCH,
					INCREASE_DATE, --增量日期:20170515 ADD BY HB
					--获取最新一条有效数据
					row_number() over(partition by ACTUALID order by AL_POPULATION_TIMESTAMP desc,INCREASE_DATE asc) rank
				FROM AL_CF_RP_PROPERTYSURVEYREPORT_INCREMENT
			) t WHERE t.rank = 1
			]]>
		</transform>

		<!-- 12. AL_CF_RP_ORGANIZATION(分支机构表)，根据主键ACTUALID去重 -->
		<transform table_name="AL_CF_RP_ORGANIZATION" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT
			  t.ACTUALID,
				t.PARENTACTUALID,
				t.TOPACTUALID,
				t.PARENTACTUALKIND,
				t.KIND,
				t.BRANCH_NO,
				t.ORGANIZATIONCODE
				,INCREASE_DATE --增量日期:20170515 ADD BY HB
			FROM
			(
				SELECT
					ACTUALID,
					PARENTACTUALID,
					TOPACTUALID,
					PARENTACTUALKIND,
					KIND,
					BRANCH_NO,
					ORGANIZATIONCODE,
					INCREASE_DATE, --增量日期:20170515 ADD BY HB
					--获取最新一条有效数据
					row_number() over(partition by ACTUALID order by AL_POPULATION_TIMESTAMP desc,INCREASE_DATE asc) rank
				FROM AL_CF_RP_ORGANIZATION_INCREMENT
			) t WHERE t.rank = 1
			]]>
		</transform>

		<!-- 13. DIM_CODE(代码名称映射表) -->
		<transform table_name="AL_CF_RP_DIM_CODE" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT
				t.DIM_TYPE,
				t.DIM_CODE,
				t.DIM_NAME,
				INCREASE_DATE --增量日期:20170515 ADD BY HB
			FROM
			(
				SELECT
					DIM_TYPE,
					DIM_CODE,
					DIM_NAME,
					INCREASE_DATE, --增量日期:20170515 ADD BY HB
					--获取最新一条有效数据
					row_number() over(partition by DIM_TYPE,DIM_CODE order by INCREASE_DATE desc) rank
				FROM
				(
					SELECT DIM_TYPE,DIM_CODE,DIM_NAME
						,MIN(INCREASE_DATE) AS INCREASE_DATE --增量日期:20170515 ADD BY HB
					FROM AL_CF_RP_DIM_CODE_INCREMENT
					GROUP BY DIM_TYPE,DIM_CODE,DIM_NAME
				) aa
			) t WHERE t.rank = 1
			]]>
		</transform>

		<!-- 14. AL_CF_RP_NOTIFICATION(报案信息表)，根据主键ACTUALID去重 -->
		<transform table_name="AL_CF_RP_NOTIFICATION" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT
				t.ACTUALID,
				t.TOPACTUALID,
				t.PARENTACTUALKIND,
				t.KIND,
				t.ACCIDENTSTATEMENT
				,INCREASE_DATE --增量日期:20170515 ADD BY HB
			FROM
			(
				SELECT
					ACTUALID,
					TOPACTUALID,
					PARENTACTUALKIND,
					KIND,
					ACCIDENTSTATEMENT,
					INCREASE_DATE, --增量日期:20170515 ADD BY HB
					--获取最新一条有效数据
					row_number() over(partition by ACTUALID order by AL_POPULATION_TIMESTAMP desc,INCREASE_DATE asc) rank
				FROM AL_CF_RP_NOTIFICATION_INCREMENT
			) t WHERE t.rank = 1
			]]>
		</transform>
		<!--******************************** 增量数据，根据原表主键先去重 end *********************************-->

		<!--******************************** 1.有效理算书 处理流程start *********************************-->
		<!-- 有效理算书 -->
		<transform table_name="jack_generateid_adjustmentinfo" type="sql" >
			<![CDATA[
				SELECT DISTINCT
					TOPACTUALID CASEFOLDERID,
					SUBSTR(ADJUSTMENTNOOFCTP,1,18) CLAIMNO,
					ADJUSTMENTNOOFCTP ADJUSTMENTNO,
					'CTP' CLAIMTYPE,
					'ADJUSTMENTNOOFCTP' CLAIM,
					CASE WHEN TOTALCTPPAYMENT IS NULL THEN ACTUALPAYMENTOFFDEDUCTIBLE ELSE TOTALCTPPAYMENT END TOTAL_OBJECT_AMOUNT,
					STATUSOFCTPADJUSTMENT ADJUSTMENTSTATUSCODE
                    ,INCREASE_DATE --增量日期:20170515 ADD BY HB
				FROM AL_CF_RP_ADJUSTMENTINFO 
				WHERE ADJUSTMENTNOOFCTP IS NOT NULL AND VERSIONTAG = 'C'

				UNION

				SELECT DISTINCT
					TOPACTUALID CASEFOLDERID,
					SUBSTR(ADJUSTMENTNOOFCOMMERCIAL,1,18) CLAIMNO,
					ADJUSTMENTNOOFCOMMERCIAL ADJUSTMENTNO,
					'COMM' CLAIMTYPE,
					'ADJUSTMENTNOOFCOMMERCIAL' CLAIM,
					CASE WHEN TOTALCOMMERCIALPAYMENT IS NULL THEN ACTUALPAYMENTOFFDEDUCTIBLE ELSE TOTALCOMMERCIALPAYMENT END TOTAL_OBJECT_AMOUNT,
					STATUSOFCOMMERCIALADJUSTMENT ADJUSTMENTSTATUSCODE
                    ,INCREASE_DATE --增量日期:20170515 ADD BY HB
				FROM AL_CF_RP_ADJUSTMENTINFO 
				WHERE ADJUSTMENTNOOFCOMMERCIAL IS NOT NULL AND VERSIONTAG = 'C'
			]]>                                    
		</transform>
		<!--******************************** 1.有效理算书 处理流程end     *********************************-->
		
		<!--******************************** 2.理算书金额表 处理流程start *********************************-->
		<!-- 理算书金额表-->
		<transform table_name="jack_generateid_adjustment_amount" type="sql" >
			<![CDATA[
				  SELECT DISTINCT
					CASEFOLDERID,
					CAST(CAST(SUM(CASE WHEN ADJUSTMENTSTATUSCODE='01' THEN TOTAL_OBJECT_AMOUNT ELSE NULL END) AS DECIMAL(20,2)) AS STRING) CLAIMAMOUNT
                    ,MAX(INCREASE_DATE) AS INCREASE_DATE --增量日期:20170515 ADD BY HB
				  FROM jack_generateid_adjustmentinfo
				  GROUP BY CASEFOLDERID                
			]]>                        
		</transform>
		<!--******************************** 2.理算书金额表 处理流程end *********************************-->
				
		<!--******************************** 3.车辆信息表 处理流程start *********************************-->
		<!-- step1_1: 获取基本信息和三者标记 -->
		<transform table_name="jack_preprocessing_thirdparty" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT
			  DISTINCT
				a.ACTUALID,
				a.TOPACTUALID,
				a.PARENTACTUALID,
				a.VIN,
				a.PLATENO,
				a.VEHICLEREGISTERDATE,
				a.PURCHASEPRICE,
				a.ENGINENO,
				a.CREATEDATE,
				a.MOLDNAME, --车型名称
				a.VEHICLEGROUPNAME, --车组名称
				a.BRANDNAME, --品牌名称
				a.ACCIDENTVEHICLELOCATION, --事故车当前位置
				b.THIRDPARTYFLAG --三者标记
                --增量日期:20170515 ADD BY HB
                ,jack_max_date_udf(a.INCREASE_DATE, b.INCREASE_DATE) AS INCREASE_DATE
			FROM AL_CF_RP_ACCIDENTVEHICLE a
			LEFT JOIN AL_CF_RP_VEHICLECONDITION b 
				ON a.TOPACTUALID = b.TOPACTUALID
				AND a.PARENTACTUALID = b.ACTUALID
				AND b.PARENTACTUALKIND = 'CASEFOLDER.ACCIDENT.LOSSINVOLVED'
				AND b.KIND = 'VEHICLECONDITIONINFO'
			WHERE a.PARENTACTUALKIND = 'CASEFOLDER.ACCIDENT.LOSSINVOLVED.VEHICLECONDITIONINFO'
			]]>
		</transform>

		<!-- step1_2: 按案卷号和标的/三者车类型，拼接标的车车牌和车架信息，用作案件实体的属性 -->
		<transform table_name="jack_preprocessing_vehicle_for_different_kind" type="sql" transform_mode="overwrite" localpath="./external">
			<![CDATA[
			SELECT
				a.TOPACTUALID,
				a.KIND,
				concat_ws('@',collect_set(NVL(a.VIN,'未知'))) as VIN_SET,
				concat_ws('@',collect_set(NVL(a.PLATENO,'未知'))) as PLATENO_SET 
			FROM
			(
				SELECT
					TOPACTUALID,
					case when (THIRDPARTYFLAG is null OR THIRDPARTYFLAG = 'N') then 'TARGET_CAR'  --标的车
							 when THIRDPARTYFLAG = 'Y' then 'THIRD_PARTY_CAR'  --三者车
							 end as KIND,
					VIN,
					PLATENO
				FROM jack_preprocessing_thirdparty
			) a GROUP BY a.TOPACTUALID, a.KIND
			]]>
		</transform>

		<!-- step1_3: 获取维修厂信息 -->
		<transform table_name="jack_preprocessing_garage" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT DISTINCT
			  aa.TOPACTUALID,
			  aa.GARAGE_CODE,
			  aa.GARAGE_NAME
              ,INCREASE_DATE --增量日期:20170515 ADD BY HB
			FROM
			(
				SELECT
				  DISTINCT
					c.TOPACTUALID,
					c.GARAGE_CODE,
					c.GARAGE_NAME,
                    --增量日期:20170515 ADD BY HB
                    jack_max_date_udf(a.INCREASE_DATE, b.INCREASE_DATE, c.INCREASE_DATE) AS INCREASE_DATE,
					ROW_NUMBER() OVER(PARTITION BY a.TOPACTUALID ORDER BY a.LOSSASSESSMENTNEED DESC) ROWN  --排序取最新
				FROM AL_CF_RP_VEHICLECONDITION a
				JOIN AL_CF_RP_VEHICLEASSESSMENT b
				  ON a.TOPACTUALID = b.TOPACTUALID 
				  AND a.ACTUALID = b.PARENTACTUALID
				JOIN AL_CF_RP_GARAGE c
				  ON c.PARENTACTUALKIND='CASEFOLDER.ACCIDENT.LOSSINVOLVED.VEHICLECONDITIONINFO.VEHICLEASSESSMENT'
				  AND a.TOPACTUALID = c.TOPACTUALID 
				  AND b.ACTUALID = c.PARENTACTUALID
				WHERE a.LOSSASSESSMENTNEED='Y'
			) aa
			WHERE aa.ROWN = 1
			]]>
		</transform>

		<!-- step1_4: 合并车辆相关信息 -->
		<transform table_name="jack_preprocessing_vehicle" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT
			  DISTINCT
				a.TOPACTUALID,
				a.VIN,
				a.PLATENO,
				a.VEHICLEREGISTERDATE,
				a.PURCHASEPRICE,
				a.ENGINENO,
				a.MOLDNAME,
				a.VEHICLEGROUPNAME,
				a.BRANDNAME,
				a.ACCIDENTVEHICLELOCATION,
				a.THIRDPARTYFLAG,
				b.GARAGE_CODE,
				b.GARAGE_NAME,
				a.CREATEDATE
                --增量日期:20170515 ADD BY HB
                ,jack_max_date_udf(a.INCREASE_DATE, b.INCREASE_DATE) AS INCREASE_DATE
			FROM jack_preprocessing_thirdparty a
			LEFT JOIN jack_preprocessing_garage b ON a.TOPACTUALID = b.TOPACTUALID
			  WHERE a.VIN is not NULL OR a.PLATENO is not NULL
			]]>
		</transform>

		<!-- step2: 如果同一个案件中三者车的车架号和标的车的车架号相同，如果车牌也相同，则删除三者车的记录，如果车牌不同，则将三者车车架置为空 
		ps:加入distinct字段是因为left join的时候会导致a表中的记录出现重复的问题-->
		<transform table_name="jack_preprocessing_thirdparty_vehicle" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			select 
				DISTINCT
				a.TOPACTUALID,
				case when b.TOPACTUALID is not NULL and b.VIN is not NULL and b.THIRDPARTYFLAG is not NULL and a.PLATENO != b.PLATENO then NULL
				else a.VIN end as VIN,
				a.PLATENO,
				a.VEHICLEREGISTERDATE,
				a.PURCHASEPRICE,
				a.MOLDNAME,
				a.ENGINENO,
				a.BRANDNAME,
			    a.VEHICLEGROUPNAME,
			    a.ACCIDENTVEHICLELOCATION,
				a.CREATEDATE, 
				a.THIRDPARTYFLAG,
				a.GARAGE_CODE,
				a.GARAGE_NAME
                ,a.INCREASE_DATE --增量日期:20170515 ADD BY HB
			from jack_preprocessing_vehicle a 
			left join
			(
                select 
					 TOPACTUALID,
					 VIN,
					 THIRDPARTYFLAG,
					 PLATENO 	
				 from jack_preprocessing_vehicle 
				 group by TOPACTUALID,VIN,THIRDPARTYFLAG,PLATENO
            ) b on a.TOPACTUALID = b.TOPACTUALID and a.THIRDPARTYFLAG='Y' and b.THIRDPARTYFLAG='N' and a.VIN=b.VIN 
			  where (b.TOPACTUALID is NULL and b.VIN is NULL and b.THIRDPARTYFLAG is NULL) or (b.TOPACTUALID is not NULL and b.VIN is not NULL and b.THIRDPARTYFLAG is not NULL and a.PLATENO != b.PLATENO)
			]]>
		</transform>

		<!-- step3: 为每条车辆信息生成DAJAID  -->
		<transform table_name="jack_generateid_vehicle_with_dajaid" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			select 
				case when a.PLATENO is NULL then CONCAT('V','0000','0000',NVL(a.VIN,'未知'))
				  when a.PLATENO is not NULL then CONCAT('V','0000','0000',NVL(a.PLATENO,'未知'))
				  else CONCAT('V','0000','0000','未知') end as DAJAID,
				a.TOPACTUALID,
				a.VIN,
				a.PLATENO,
				a.VEHICLEREGISTERDATE,
				a.PURCHASEPRICE,
				a.MOLDNAME,
				a.ENGINENO,
				a.BRANDNAME,
			    a.VEHICLEGROUPNAME,
			    a.ACCIDENTVEHICLELOCATION,
				a.CREATEDATE, 
				a.THIRDPARTYFLAG,
				a.GARAGE_CODE,
				a.GARAGE_NAME
                ,a.INCREASE_DATE --增量日期:20170515 ADD BY HB
			from jack_preprocessing_thirdparty_vehicle a 
			  where a.VIN is not NULL or a.PLATENO is not NULL
			]]>
		</transform>

		<!-- step4: 同一个案件中，相同车牌和角色的记录取最新的记录 -->
		<transform table_name="jack_generateid_vehicle_without_reduplication" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			select 
                a.DAJAID,
                a.TOPACTUALID,
                a.VIN,
                a.PLATENO,
                a.VEHICLEREGISTERDATE,
                a.PURCHASEPRICE,
                a.MOLDNAME,
                a.ENGINENO,
                a.BRANDNAME,
                a.VEHICLEGROUPNAME,
                a.ACCIDENTVEHICLELOCATION,
                a.CREATEDATE, 
                a.THIRDPARTYFLAG,
                a.GARAGE_CODE,
                a.GARAGE_NAME
                ,a.INCREASE_DATE --增量日期:20170515 ADD BY HB
			from
			(
                select 
					DAJAID,
					TOPACTUALID,
					VIN,
					PLATENO,
					VEHICLEREGISTERDATE,
					PURCHASEPRICE,
					MOLDNAME,
					ENGINENO,
					BRANDNAME,
				    VEHICLEGROUPNAME,
				    ACCIDENTVEHICLELOCATION,
					CREATEDATE, 
					THIRDPARTYFLAG,
					GARAGE_CODE,
					GARAGE_NAME,
                    INCREASE_DATE, --增量日期:20170515 ADD BY HB
					row_number() over (partition by TOPACTUALID,DAJAID,THIRDPARTYFLAG order by CREATEDATE desc) rank	
				 from jack_generateid_vehicle_with_dajaid
            ) a where a.rank = 1
			]]>
		</transform>

		<!-- step5: 合并同车牌记录的车架号属性值，并放在LATEST_VIN属性值中 -->
		<transform table_name="jack_generateid_vehicle" type="sql" >
			<![CDATA[
			select  
				a.DAJAID,
				a.TOPACTUALID,
				a.VIN,
				case when a.PLATENO is NULL then NVL(VIN,'未知')
				  else b.VIN_SET end as LATEST_VIN,
				a.PLATENO,
				a.VEHICLEREGISTERDATE,
				a.PURCHASEPRICE,
				a.MOLDNAME,
				a.ENGINENO,
				a.BRANDNAME,
			    a.VEHICLEGROUPNAME,
			    a.ACCIDENTVEHICLELOCATION,
				a.CREATEDATE, 
				a.THIRDPARTYFLAG,
				a.GARAGE_CODE,
				a.GARAGE_NAME,
				'VEHICLE' AS TYPE,
				0 AS IS_DELETE,
				0 AS IS_RANDOM
                ,a.INCREASE_DATE --增量日期:20170515 ADD BY HB
			from jack_generateid_vehicle_without_reduplication a 
			left join 				
			(
				select 
					concat_ws('-',collect_set(NVL(VIN,'未知'))) as VIN_SET,
					PLATENO 
				from jack_generateid_vehicle_without_reduplication
				where PLATENO is not null 
				group by PLATENO
			) b on a.PLATENO = b.PLATENO 
			where a.DAJAID != 'V00000000未知'
			]]>
		</transform>
		<!--******************************** 3.车辆信息表 处理流程end *********************************-->

		<!--******************************** 4.人员信息表 处理流程start   *********************************-->
		<!-- 按案卷号和人员类型拼接姓名和电话，用作案件实体的属性 -->
		<transform table_name="jack_preprocessing_person_for_different_kind" type="sql" transform_mode="overwrite" localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			select 
				TOPACTUALID,
				KIND,
				concat_ws('@',collect_set(NAME)) as NAME_SET,
				concat_ws('@',collect_set(TEL)) as TEL_SET 
			from AL_CF_RP_RELATEDPERSONNEL
			where KIND in ('REPORTER','INSURANT','THEINJURED','VEHICLEOWNER')
			group by TOPACTUALID, KIND
			
			union all
			
			select 
				c.TOPACTUALID,
				c.KIND,
				concat_ws('@',collect_set(c.NAME)) as NAME_SET,
				concat_ws('@',collect_set(c.TEL)) as TEL_SET 
			from
			(
				select DISTINCT
					b.TOPACTUALID,  
					b.CERTIFICATENO, 
					b.CERTIFICATETYPE,
					b.NAME,
					b.TEL, 
					case when a.thirdpartyflag='Y' then 'THIRD_PARTY_ACCIDENTDRIVER'
							 when (a.thirdpartyflag is null or a.thirdpartyflag='N') then 'ACCIDENTDRIVER' end as KIND,
					b.EMAIL,
					b.ADDRESS,
					b.CREATEDATE 
				from AL_CF_RP_VEHICLECONDITION a, AL_CF_RP_RELATEDPERSONNEL b 
				where a.topactualid = b.topactualid 
				and b.parentactualid = a.actualid
				and a.parentactualkind = 'CASEFOLDER.ACCIDENT.LOSSINVOLVED'
				and b.parentactualkind = 'CASEFOLDER.ACCIDENT.LOSSINVOLVED.VEHICLECONDITIONINFO'
				and b.kind = 'ACCIDENTDRIVER'
			) c group by c.TOPACTUALID, c.KIND
			]]>
		</transform>

		<!-- 将出险驾驶员分为标的车驾驶员或者三者车驾驶员 -->
		<transform table_name="jack_preprocessing_person_for_thirdpartydriver" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			select DISTINCT
				a.TOPACTUALID,  
				a.CERTIFICATENO, 
				a.CERTIFICATETYPE,
				a.NAME,
				--20170606新增：除报案电话、伤者电话、标的/三者驾驶员电话外，其余都删除
				case when a.KIND = 'THEINJURED' then a.TEL
						 else NULL end as TEL,
				a.KIND,
				a.EMAIL,
				a.ADDRESS,
				a.CREATEDATE
                ,a.INCREASE_DATE --增量日期:20170515 ADD BY HB
			from AL_CF_RP_RELATEDPERSONNEL a 
			where a.KIND IN ('INSURANT','THEINJURED','VEHICLEOWNER')
			  --证件类型为“身份证”或者“驾驶证”
			  and (a.CERTIFICATETYPE = '1' OR a.CERTIFICATETYPE = '15')
			  and validateCard(a.CERTIFICATENO) = true
			
			union all
			 
			select DISTINCT 
				b.TOPACTUALID,  
				b.CERTIFICATENO, 
				b.CERTIFICATETYPE,
				b.NAME,
				b.TEL,
				case when a.thirdpartyflag='Y' then 'THIRD_PARTY_ACCIDENTDRIVER'
						 when (a.thirdpartyflag is null or a.thirdpartyflag='N') then 'ACCIDENTDRIVER' end as KIND,
				b.EMAIL,
				b.ADDRESS,
				b.CREATEDATE
                --增量日期:20170515 ADD BY HB
                ,jack_max_date_udf(a.INCREASE_DATE, b.INCREASE_DATE) AS INCREASE_DATE
			  from AL_CF_RP_VEHICLECONDITION a, AL_CF_RP_RELATEDPERSONNEL b 
			  where a.topactualid = b.topactualid
			    and b.parentactualid = a.actualid
			    and a.parentactualkind = 'CASEFOLDER.ACCIDENT.LOSSINVOLVED'
			    and b.parentactualkind = 'CASEFOLDER.ACCIDENT.LOSSINVOLVED.VEHICLECONDITIONINFO'
			    and b.kind = 'ACCIDENTDRIVER'
			    --证件类型为“身份证”或者“驾驶证”
			    and (b.CERTIFICATETYPE = '1' OR b.CERTIFICATETYPE = '15')
				and validateCard(b.CERTIFICATENO) = true
			]]>
		</transform>
		<!-- 筛选和清洗relatedpersonnel表数据,合并同一案件中相同身份和身份类型的记录，并取最新的创建时间的记录 -->
		<transform table_name="jack_preprocessing_person" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			select DISTINCT
				a.TOPACTUALID,  
				a.CERTIFICATENO, 
				a.CERTIFICATETYPE,
				a.NAME,
				a.TEL, 
				a.KIND,
				a.EMAIL,
				a.ADDRESS,
				a.CREATEDATE,
				a.rank 
                ,a.INCREASE_DATE --增量日期:20170515 ADD BY HB
			from
			(
                select
					TOPACTUALID,  
					CERTIFICATENO, 
					CERTIFICATETYPE,
					NAME,
					TEL, 
					KIND,
					EMAIL,
					ADDRESS,
					CREATEDATE,
                    INCREASE_DATE, --增量日期:20170515 ADD BY HB
					row_number() over (partition by TOPACTUALID,CERTIFICATENO,KIND order by CREATEDATE desc) rank				
				from jack_preprocessing_person_for_thirdpartydriver
			) a where a.rank = 1
            ]]>
		</transform>
		<!-- 人员信息合并,合并同身份证号的人名 -->
		<transform table_name="jack_generateid_person" type="sql">
			<![CDATA[
			select 
				DISTINCT 
				CONCAT('P','0000','0000',a.CERTIFICATENO) as DAJAID,
				case when a.TEL is null then null else CONCAT('T','0000','0000',a.TEL) end as TEL_DAJAID,
				a.TOPACTUALID,  
				a.CERTIFICATENO, 
				a.CERTIFICATETYPE, 
				b.NAME_SET as NAME,
				a.TEL, 
				a.KIND,
				a.EMAIL,
				a.ADDRESS,
				a.CREATEDATE,
				'PERSON' as TYPE,
				0 as IS_DELETE,
				0 as IS_RANDOM
                ,a.INCREASE_DATE --增量日期:20170515 ADD BY HB
			from jack_preprocessing_person a 
			left join 
			(
                select 
					CERTIFICATENO as DISTIN_CERTIFICATENO, 
					concat_ws('@',collect_set(NVL(NAME,'未知'))) as NAME_SET 
				from jack_preprocessing_person group by CERTIFICATENO
            ) b on b.DISTIN_CERTIFICATENO = a.CERTIFICATENO 
			  where length(b.NAME_SET) < 10000
			]]>
		</transform>
		<!--******************************** 4.人员信息表 处理流程end *********************************-->

		<!--******************************** 5.案件信息表 处理流程start *********************************-->
		<!-- 员工信息临时表,相同CODE的人合并OPERATORNAME -->
		<transform table_name="jack_processing_employee" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT DISTINCT
                a.CODE,
                b.NAME_SET as OPERATORNAME,
                a.UNIT_CODE,
                org.DIM_NAME AS AGENTNAME
                ,a.INCREASE_DATE --增量日期:20170515 ADD BY HB
		    FROM 
            (
                SELECT 
                    CODE,
                    OPERATORNAME,
                    UNIT_CODE,
                    INCREASE_DATE, --增量日期:20170515 ADD BY HB
                    row_number() over (partition by CODE,UNIT_CODE order by CODE desc) rank
                FROM AL_T_EMPLOYEE_VIEW
            ) a	
            LEFT JOIN 
            (
                select 
                    CODE as DISTIN_CODE,
                    UNIT_CODE,
                    concat_ws('@',collect_set(NVL(OPERATORNAME,'未知'))) as NAME_SET 
                from AL_T_EMPLOYEE_VIEW 
                group by CODE, UNIT_CODE
            ) b ON b.DISTIN_CODE = a.CODE AND b.UNIT_CODE = a.UNIT_CODE
            LEFT JOIN AL_CF_RP_DIM_CODE org on a.UNIT_CODE = org.DIM_CODE and org.DIM_TYPE='ORGANIZATION'
              WHERE a.rank = 1
			]]>
		</transform>
		<!-- 车估损单信息临时表 -->
		<transform table_name="jack_processing_vehicleassessment" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT 
				b.TOPACTUALID,
                b.ASSESSMENTSTAFF_CODE,
                b.ASSESSMENTSTAFF_NAME,
                b.ASSESSMENT_BRANCH_CODE,
                b.ASSESSMENT_BRANCH_NAME,
                b.PARENTACTUALKIND,
                b.KIND
                ,b.INCREASE_DATE --增量日期:20170515 ADD BY HB
			FROM
			(
			  SELECT 
				a.TOPACTUALID,
                a.ASSESSMENTSTAFF_CODE,
                a.ASSESSMENTSTAFF_NAME,
                a.ASSESSMENT_BRANCH_CODE,
                a.ASSESSMENT_BRANCH_NAME,
                a.PARENTACTUALKIND,
                a.KIND,
                a.INCREASE_DATE, --增量日期:20170515 ADD BY HB
                row_number() over (partition by a.TOPACTUALID order by a.TOPACTUALID desc) rank
			  FROM
			  (
				SELECT DISTINCT
                    veh.TOPACTUALID,
                    veh.ASSESSMENTSTAFF AS ASSESSMENTSTAFF_CODE,
                    emp.OPERATORNAME AS ASSESSMENTSTAFF_NAME,
                    veh.ASSESSMENTSTAFFBRANCH AS ASSESSMENT_BRANCH_CODE,
                    org.DIM_NAME AS ASSESSMENT_BRANCH_NAME,
                    veh.PARENTACTUALKIND,
                    veh.KIND
                    --增量日期:20170515 ADD BY HB
                    ,jack_max_date_udf(veh.INCREASE_DATE, emp.INCREASE_DATE, org.INCREASE_DATE) AS INCREASE_DATE
				FROM AL_CF_RP_VEHICLEASSESSMENT veh
				LEFT JOIN jack_processing_employee emp on veh.ASSESSMENTSTAFF = emp.CODE and veh.ASSESSMENTSTAFFBRANCH = emp.UNIT_CODE
				LEFT JOIN AL_CF_RP_DIM_CODE org on veh.ASSESSMENTSTAFFBRANCH = org.DIM_CODE and org.DIM_TYPE = 'ORGANIZATION'
				  WHERE veh.PARENTACTUALKIND = 'CASEFOLDER.ACCIDENT.LOSSINVOLVED.VEHICLECONDITIONINFO'
				    AND veh.KIND = 'VEHICLEASSESSMENT'
			  ) a 
			) b WHERE b.rank = 1
			]]>
		</transform>
		<!-- 车物查勘报告信息临时表 -->
		 <transform table_name="jack_processing_propertysurveyreport" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT 
				b.TOPACTUALID,
                b.SURVEYOR_CODE,
                b.SURVEYOR_NAME,
				b.SURVEYOR_BRANCH_CODE,
				b.SURVEYOR_BRANCH_NAME
                ,INCREASE_DATE --增量日期:20170515 ADD BY HB
			FROM
			(
			  SELECT 
				a.TOPACTUALID,
				a.SURVEYOR_CODE,
				a.SURVEYOR_NAME,
				a.SURVEYOR_BRANCH_CODE,
				a.SURVEYOR_BRANCH_NAME,
                a.INCREASE_DATE, --增量日期:20170515 ADD BY HB
				row_number() over (partition by a.TOPACTUALID order by a.ACTUALID desc) rank
			  FROM
			  (
                SELECT DISTINCT
                    t.ACTUALID,
                    t.TOPACTUALID,
                    CASE WHEN t.FIRSTSURVEYOR is not null and t.SECONDSURVEYOR is not null and t.FIRSTSURVEYOR != t.SECONDSURVEYOR THEN CONCAT(t.FIRSTSURVEYOR,'@',t.SECONDSURVEYOR)
                        WHEN t.FIRSTSURVEYOR is not null and t.SECONDSURVEYOR is not null and t.FIRSTSURVEYOR = t.SECONDSURVEYOR THEN t.FIRSTSURVEYOR
                        WHEN t.FIRSTSURVEYOR is not null and t.SECONDSURVEYOR is null THEN t.FIRSTSURVEYOR
                        WHEN t.FIRSTSURVEYOR is null and t.SECONDSURVEYOR is not null THEN t.SECONDSURVEYOR
                        ELSE null END as SURVEYOR_CODE,
                    CASE WHEN t.FIRST_SURVEYOR_NAME is not null and t.SECOND_SURVEYOR_NAME is not null and t.FIRST_SURVEYOR_NAME != t.SECOND_SURVEYOR_NAME THEN CONCAT(t.FIRST_SURVEYOR_NAME,'@',t.SECOND_SURVEYOR_NAME)
                        WHEN t.FIRST_SURVEYOR_NAME is not null and t.SECOND_SURVEYOR_NAME is not null and t.FIRST_SURVEYOR_NAME = t.SECOND_SURVEYOR_NAME THEN t.FIRST_SURVEYOR_NAME
                        WHEN t.FIRST_SURVEYOR_NAME is not null and t.SECOND_SURVEYOR_NAME is null THEN t.FIRST_SURVEYOR_NAME
                        WHEN t.FIRST_SURVEYOR_NAME is null and t.SECOND_SURVEYOR_NAME is not null THEN t.SECOND_SURVEYOR_NAME
                        ELSE null END as SURVEYOR_NAME,
                    CASE WHEN t.FIRSTSURVEYORBRANCH is not null and t.SECONDSURVEYORBRANCH is not null and t.FIRSTSURVEYORBRANCH != t.SECONDSURVEYORBRANCH THEN CONCAT(t.FIRSTSURVEYORBRANCH,'@',t.SECONDSURVEYORBRANCH)
                        WHEN t.FIRSTSURVEYORBRANCH is not null and t.SECONDSURVEYORBRANCH is not null and t.FIRSTSURVEYORBRANCH = t.SECONDSURVEYORBRANCH THEN t.FIRSTSURVEYORBRANCH
                        WHEN t.FIRSTSURVEYORBRANCH is not null and t.SECONDSURVEYORBRANCH is null THEN t.FIRSTSURVEYORBRANCH
                        WHEN t.FIRSTSURVEYORBRANCH is null and t.SECONDSURVEYORBRANCH is not null THEN t.SECONDSURVEYORBRANCH
                        ELSE null END as SURVEYOR_BRANCH_CODE,
                    CASE WHEN t.FIRST_SURVEYOR_BRANCH_NAME is not null and t.SECOND_SURVEYOR_BRANCH_NAME is not null and t.FIRST_SURVEYOR_BRANCH_NAME != t.SECOND_SURVEYOR_BRANCH_NAME THEN CONCAT(t.FIRST_SURVEYOR_BRANCH_NAME,'@',t.SECOND_SURVEYOR_BRANCH_NAME)
                        WHEN t.FIRST_SURVEYOR_BRANCH_NAME is not null and t.SECOND_SURVEYOR_BRANCH_NAME is not null and t.FIRST_SURVEYOR_BRANCH_NAME = t.SECOND_SURVEYOR_BRANCH_NAME THEN t.FIRST_SURVEYOR_BRANCH_NAME
                        WHEN t.FIRST_SURVEYOR_BRANCH_NAME is not null and t.SECOND_SURVEYOR_BRANCH_NAME is null THEN t.FIRST_SURVEYOR_BRANCH_NAME
                        WHEN t.FIRST_SURVEYOR_BRANCH_NAME is null and t.SECOND_SURVEYOR_BRANCH_NAME is not null THEN t.SECOND_SURVEYOR_BRANCH_NAME
                        ELSE null END as SURVEYOR_BRANCH_NAME
                    ,t.INCREASE_DATE --增量日期:20170515 ADD BY HB
                FROM
                (
                    SELECT
                        pro.ACTUALID,
                        pro.TOPACTUALID,
                        pro.FIRSTSURVEYOR,
                        emp1.OPERATORNAME as FIRST_SURVEYOR_NAME,
                        pro.SECONDSURVEYOR,
                        emp2.OPERATORNAME as SECOND_SURVEYOR_NAME,
                        pro.FIRSTSURVEYORBRANCH,
                        org1.DIM_NAME AS FIRST_SURVEYOR_BRANCH_NAME,
                        pro.SECONDSURVEYORBRANCH,
                        org2.DIM_NAME AS SECOND_SURVEYOR_BRANCH_NAME,
                        pro.PARENTACTUALKIND,
                        pro.KIND
                        --增量日期:20170515 ADD BY HB
                        ,jack_max_date_udf(pro.INCREASE_DATE, emp1.INCREASE_DATE, emp2.INCREASE_DATE, org1.INCREASE_DATE, org2.INCREASE_DATE) AS INCREASE_DATE
                    FROM AL_CF_RP_PROPERTYSURVEYREPORT pro
                    LEFT JOIN jack_processing_employee emp1 on pro.FIRSTSURVEYOR = emp1.CODE and pro.FIRSTSURVEYORBRANCH = emp1.UNIT_CODE
                    LEFT JOIN jack_processing_employee emp2 on pro.SECONDSURVEYOR = emp2.CODE and pro.SECONDSURVEYORBRANCH = emp2.UNIT_CODE
                    LEFT JOIN AL_CF_RP_DIM_CODE org1 ON org1.DIM_CODE = pro.FIRSTSURVEYORBRANCH and org1.DIM_TYPE = 'ORGANIZATION'
			        LEFT JOIN AL_CF_RP_DIM_CODE org2 ON org2.DIM_CODE = pro.SECONDSURVEYORBRANCH and org2.DIM_TYPE = 'ORGANIZATION'
                    WHERE pro.PARENTACTUALKIND = 'CASEFOLDER.SURVEYREPORT'
                      AND pro.KIND = 'PROPERTYSURVEYREPORT'
                ) t
		      ) a
			) b WHERE b.rank = 1
			]]>
		</transform>
		<!-- 案件信息表 -->
		<!--
			变更 20170526：LJC
				新增对ACCIDENTCAUSE字段中魔法数字的中文解释
			变更 20170606：LJC
				新增人和电话字段
		-->
		<transform table_name="jack_generateid_case" type="sql" >
			<![CDATA[
			SELECT 
			  DISTINCT 
				CONCAT('C','0000','0000',cf.CASEFOLDERID) AS DAJAID,
				case when cf.NOTIFICATIONTEL is null then null else CONCAT('T','0000','0000',cf.NOTIFICATIONTEL) end AS TEL_DAJAID,
				cf.CASEFOLDERID,
				cf.NOTIFICATIONNO,                                                                            
				cf.NOTIFICATIONDATE,                                                                          
				cf.NOTIFICATIONTEL, 
				p1.NAME_SET AS NOTIFICATIONNAME,
				cf.BRANCH_CODE AS UNDERWIRTING_BRANCH_CODE,
				org1.DIM_NAME AS UNDERWIRTING_BRANCH_NAME,
				cf.ACCIDENTCAUSE AS ACCIDENTCAUSE_CODE,
				cause.DIM_NAME AS ACCIDENTCAUSE,  
				noti.ACCIDENTSTATEMENT,                                                                           
				cf.ACCIDENTDATE,                                                                              
				cf.ACCIDENTLOCATION,
				cf.ISINJURYINVOLVED,
				cf.ACCIDENTBRANCH AS ACCIDENT_BRANCH_CODE,
				org2.DIM_NAME AS ACCIDENT_BRANCH_NAME,
				veh.ASSESSMENTSTAFF_CODE,
				veh.ASSESSMENTSTAFF_NAME,
				veh.ASSESSMENT_BRANCH_CODE,
				veh.ASSESSMENT_BRANCH_NAME,
				pro.SURVEYOR_CODE,
				pro.SURVEYOR_NAME,
				pro.SURVEYOR_BRANCH_CODE,
				pro.SURVEYOR_BRANCH_NAME,
				adj.CLAIMAMOUNT,
				
				--20170606新增属性：
				p2.NAME_SET as INSURANT_NAME,  --被保险人姓名
				p3.NAME_SET as THEINJURED_NAME,  --伤者姓名
				p3.TEL_SET as THEINJURED_TEL,  --伤者电话
				p4.NAME_SET as VEHICLEOWNER_NAME,  --行驶证车主姓名
				p5.NAME_SET as ACCIDENTDRIVER_NAME,  --标的车驾驶员姓名
				p5.TEL_SET as ACCIDENTDRIVER_TEL,  --事故信息中录入的标的车驾驶员电话
				p1.TEL_SET as ACCIDENTDRIVER_TEL2, --报案信息中95500记录的标的车驾驶员联系电话
				p6.NAME_SET as THIRD_PARTY_ACCIDENTDRIVER_NAME,  --三者车驾驶员姓名
				p6.TEL_SET as THIRD_PARTY_ACCIDENTDRIVER_TEL,  --三者车驾驶员电话
				c1.VIN_SET as TARGET_CAR_VIN, --标的车车架号
				c1.PLATENO_SET as TARGET_CAR_PLATENO,  --标的车车牌号
				c2.VIN_SET as THIRD_PARTY_CAR_VIN, --三者车车架号
				c2.PLATENO_SET as THIRD_PARTY_CAR_PLATENO,  --三者车车牌号
				
				'CASE' as TYPE,
				0 as IS_DELETE,
				0 as IS_RANDOM

				--增量日期:20170515 ADD BY HB
                ,jack_max_date_udf(cf.INCREASE_DATE, org1.INCREASE_DATE, org2.INCREASE_DATE, cause.INCREASE_DATE, veh.INCREASE_DATE, pro.INCREASE_DATE, adj.INCREASE_DATE, noti.INCREASE_DATE) AS INCREASE_DATE

			FROM AL_CF_IDX_CASEFOLDER cf
			LEFT JOIN jack_preprocessing_person_for_different_kind p1 ON p1.KIND = 'REPORTER' AND cf.CASEFOLDERID = p1.TOPACTUALID
			LEFT JOIN jack_preprocessing_person_for_different_kind p2 ON p2.KIND = 'INSURANT' AND cf.CASEFOLDERID = p2.TOPACTUALID
			LEFT JOIN jack_preprocessing_person_for_different_kind p3 ON p3.KIND = 'THEINJURED' AND cf.CASEFOLDERID = p3.TOPACTUALID
			LEFT JOIN jack_preprocessing_person_for_different_kind p4 ON p4.KIND = 'VEHICLEOWNER' AND cf.CASEFOLDERID = p4.TOPACTUALID
			LEFT JOIN jack_preprocessing_person_for_different_kind p5 ON p5.KIND = 'ACCIDENTDRIVER' AND cf.CASEFOLDERID = p5.TOPACTUALID
			LEFT JOIN jack_preprocessing_person_for_different_kind p6 ON p6.KIND = 'THIRD_PARTY_ACCIDENTDRIVER' AND cf.CASEFOLDERID = p6.TOPACTUALID
			LEFT JOIN jack_preprocessing_vehicle_for_different_kind c1 ON c1.KIND = 'TARGET_CAR' AND cf.CASEFOLDERID = c1.TOPACTUALID
			LEFT JOIN jack_preprocessing_vehicle_for_different_kind c2 ON c2.KIND = 'THIRD_PARTY_CAR' AND cf.CASEFOLDERID = c2.TOPACTUALID
			LEFT JOIN AL_CF_RP_DIM_CODE org1 ON org1.DIM_CODE = cf.BRANCH_CODE and org1.DIM_TYPE = 'ORGANIZATION'
			LEFT JOIN AL_CF_RP_DIM_CODE org2 ON org2.DIM_CODE = cf.ACCIDENTBRANCH and org2.DIM_TYPE = 'ORGANIZATION'
			LEFT JOIN AL_CF_RP_DIM_CODE cause ON cause.DIM_CODE = cf.ACCIDENTCAUSE and cause.DIM_TYPE = 'ACCIDENTCAUSE'
			LEFT JOIN jack_processing_vehicleassessment veh ON cf.CASEFOLDERID = veh.TOPACTUALID
			LEFT JOIN jack_processing_propertysurveyreport pro ON cf.CASEFOLDERID = pro.TOPACTUALID
			LEFT JOIN jack_generateid_adjustment_amount adj ON cf.CASEFOLDERID = adj.CASEFOLDERID    
			LEFT JOIN AL_CF_RP_NOTIFICATION noti ON cf.CASEFOLDERID = noti.TOPACTUALID
			]]>                                   
		</transform>
		<!--******************************** 5.案件信息表 处理流程end *********************************-->
		
		<!--******************************** 6.有效案件号表 处理流程start *********************************-->
		<!-- 取近三年的数据，并细分到赔案级别 -->
		<transform table_name="jack_tmp_valuablecase_01" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT DISTINCT
                CASEFOLDERID,
                NOTIFICATIONNO,
                CTPCLAIMNO CLAIMNO,
                CTPSTATUS CASESTATUSCODE,
                'CTP' CLAIMTYPE,
                ACCIDENTDATE
            FROM AL_CF_IDX_CASEFOLDER 
            WHERE CTPCLAIMNO IS NOT NULL AND ACCIDENTDATE >= concat(year(current_date)-3, '-01-01 00:00:00')
				
            UNION
            
            SELECT DISTINCT
                CASEFOLDERID,
                NOTIFICATIONNO,
                CLAIMNO CLAIMNO,
                STATUS CASESTATUSCODE,
                'COMM' CLAIMTYPE,
                ACCIDENTDATE
            FROM AL_CF_IDX_CASEFOLDER 
            WHERE CLAIMNO IS NOT NULL AND ACCIDENTDATE >= concat(year(current_date)-3, '-01-01 00:00:00')
			]]>
		</transform>
		<!-- 近三年未决案件 -->
		<transform table_name="jack_tmp_valuablecase_pending" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT DISTINCT
			  CASEFOLDERID,
			  NOTIFICATIONNO,
			  ACCIDENTDATE
			FROM jack_tmp_valuablecase_01 
			  WHERE CASESTATUSCODE IN ('0','1','2')   
			]]>                                              
		</transform>
		<!-- 近三年已决案件 -->
		<transform table_name="jack_tmp_valuablecase_02" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT DISTINCT
					CASEFOLDERID,
					NOTIFICATIONNO,
					CLAIMNO,
					CASESTATUSCODE,
					CLAIMTYPE,
					ACCIDENTDATE
			FROM jack_tmp_valuablecase_01
			  WHERE CASESTATUSCODE IN ('3','4','5','6','7')                   
			]]>                            
		</transform>
		<!-- 有效理算书的赔案级别的理算金额 -->
		<transform table_name="jack_tmp_valuablecase_04" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			SELECT DISTINCT
					CASEFOLDERID,
					CLAIMNO,
					CAST(CAST(SUM(CASE WHEN ADJUSTMENTSTATUSCODE='01' THEN TOTAL_OBJECT_AMOUNT ELSE NULL END) AS DECIMAL(20,2)) AS STRING) CLAIMAMOUNT
				FROM jack_generateid_adjustmentinfo GROUP BY CASEFOLDERID,CLAIMNO  
			]]>                                           
		</transform>
		<!-- 理算金额大于1000的近三年已决案件 -->
		<transform table_name="jack_tmp_valuablecase_decided" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
				SELECT DISTINCT
					a.CASEFOLDERID,
					a.NOTIFICATIONNO
				FROM jack_tmp_valuablecase_02 a
				JOIN
                (
				  SELECT CLAIMNO FROM jack_tmp_valuablecase_04 WHERE claimamount > 1000
				) b	on a.claimno=b.claimno                              
			]]>           
		</transform>
		<!-- 有效案件号表，近三年出险，所有未决案件和理算金额大于1000的已决案件 -->
		<transform table_name="jack_generateid_valuablecase_no" type="sql">
			<![CDATA[
				SELECT DISTINCT 
				  NOTIFICATIONNO
				FROM jack_tmp_valuablecase_pending
				  WHERE NOTIFICATIONNO IS NOT NULL   

				UNION

				SELECT DISTINCT 
				  NOTIFICATIONNO
				FROM jack_tmp_valuablecase_decided
				  WHERE NOTIFICATIONNO IS NOT NULL                   
			]]>                   
		</transform>
		<!--******************************** 6.有效案件号表 处理流程end *********************************-->
		
		<!--******************************** 7.有效案件表 处理流程start *********************************-->
		<!-- 有效案件表-->
		<!--
			变更 20170526：LJC
				新增对ACCIDENTCAUSE字段中魔法数字的中文解释
		-->
		<transform table_name="jack_generateid_valuablecase" type="sql" >
			<![CDATA[
			SELECT DISTINCT 
                cf.DAJAID,
                cf.TEL_DAJAID,
				cf.CASEFOLDERID,
				cf.NOTIFICATIONNO,                                                                            
				cf.NOTIFICATIONDATE,                                                                          
				cf.NOTIFICATIONTEL, 
				cf.NOTIFICATIONNAME,
				cf.UNDERWIRTING_BRANCH_CODE,
				cf.UNDERWIRTING_BRANCH_NAME,
				cf.ACCIDENTCAUSE_CODE,
				cf.ACCIDENTCAUSE,       
				cf.ACCIDENTSTATEMENT,                                                                      
				cf.ACCIDENTDATE,                                                                              
				cf.ACCIDENTLOCATION,
				cf.ISINJURYINVOLVED,
				cf.ACCIDENT_BRANCH_CODE,
				cf.ACCIDENT_BRANCH_NAME,
				cf.ASSESSMENTSTAFF_CODE,
				cf.ASSESSMENTSTAFF_NAME,
				cf.ASSESSMENT_BRANCH_CODE,
				cf.ASSESSMENT_BRANCH_NAME,
				cf.SURVEYOR_CODE,
				cf.SURVEYOR_NAME,
				cf.SURVEYOR_BRANCH_CODE,
				cf.SURVEYOR_BRANCH_NAME,
				cf.CLAIMAMOUNT,

				--20170606新增属性：
				cf.INSURANT_NAME,  --被保险人姓名
				cf.THEINJURED_NAME,  --伤者姓名
				cf.THEINJURED_TEL,  --伤者电话
				cf.VEHICLEOWNER_NAME,  --行驶证车主姓名
				cf.ACCIDENTDRIVER_NAME,  --标的车驾驶员姓名
				cf.ACCIDENTDRIVER_TEL,  --事故信息中录入的标的车驾驶员电话
				cf.ACCIDENTDRIVER_TEL2, --报案信息中95500记录的标的车驾驶员联系电话
				cf.THIRD_PARTY_ACCIDENTDRIVER_NAME,  --三者车驾驶员姓名
				cf.THIRD_PARTY_ACCIDENTDRIVER_TEL,  --三者车驾驶员电话
				cf.TARGET_CAR_VIN, --标的车车架号
				cf.TARGET_CAR_PLATENO,  --标的车车牌号
				cf.THIRD_PARTY_CAR_VIN, --三者车车架号
				cf.THIRD_PARTY_CAR_PLATENO,  --三者车车牌号
				
				cf.TYPE,
				cf.IS_DELETE,
				cf.IS_RANDOM
                ,cf.INCREASE_DATE --增量日期:20170515 ADD BY HB
			FROM jack_generateid_case cf, jack_generateid_valuablecase_no vc
			WHERE cf.NOTIFICATIONNO = vc.NOTIFICATIONNO                        
			]]>                   
		</transform>
		<!--******************************** 7.有效案件表 处理流程end *********************************-->

		<!--******************************** 8.保单信息表 处理流程start *********************************-->
		<!-- 保单信息表 -->
		<transform table_name="jack_generateid_insurance" type="sql">
			<![CDATA[
            SELECT DISTINCT 
                CONCAT('I','0000','0000',ins.POLICYNO) AS DAJAID,
                ins.TOPACTUALID, 
                ins.POLICYNO,
                ins.POLICYTYPE,
                org.BRANCH_NO AS BRANCH_CODE,
                org.BRANCH_NAME,                                                                               
                ins.KIND, 
                ins.EFFECTIVEDATE,
                ins.EXPIREDATE,
                ins.AGENTCODE,
                emp.AGENTNAME AS AGENTNAME,
                ins.OPERATORCODE AS OPERATORCODE,
                emp.OPERATORNAME AS OPERATORNAME,
                ins.CREATEDATE,
                'INSURANCE_PRODUCT' as TYPE,
                0 as IS_DELETE,
                0 as IS_RANDOM
                --增量日期:20170515 ADD BY HB
                ,jack_max_date_udf(ins.INCREASE_DATE, org.INCREASE_DATE, emp.INCREASE_DATE) AS INCREASE_DATE
            FROM AL_CF_RP_INSURANCEPRODUCT ins
            LEFT JOIN
            (
                SELECT DISTINCT
                    o.ACTUALID,
                    o.PARENTACTUALID,
                    o.TOPACTUALID,
                    o.BRANCH_NO,
                    d.DIM_NAME AS BRANCH_NAME,
                    o.PARENTACTUALKIND,
                    o.KIND
					--增量日期:20170515 ADD BY HB
                    ,jack_max_date_udf(o.INCREASE_DATE, d.INCREASE_DATE) AS INCREASE_DATE
                FROM AL_CF_RP_ORGANIZATION o
                LEFT JOIN AL_CF_RP_DIM_CODE d ON d.DIM_CODE = o.BRANCH_NO and d.DIM_TYPE = 'ORGANIZATION'
                  WHERE o.PARENTACTUALKIND IN ('CASEFOLDER.POLICY.COMMERCIALINSURANCE','CASEFOLDER.POLICY.CTP')
                    AND o.KIND = 'ORGANIZATION'
            ) org ON org.TOPACTUALID = ins.TOPACTUALID AND org.PARENTACTUALID = ins.ACTUALID                                     
            LEFT JOIN jack_processing_employee emp ON ins.OPERATORCODE = emp.CODE and ins.AGENTCODE = emp.UNIT_CODE
			]]>                                                  
		</transform>
		<!--******************************** 8.保单信息表 处理流程end *********************************-->

		<!--******************************** 9.支付账号信息表 处理流程start *********************************-->
		<!-- 筛选和清洗settlement_account表数据 -->
		<transform table_name="jack_preprocessing_settlementaccount_1" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			select 
				distinct 
				CONCAT('S','0000','0000',ACCOUNTNO) AS DAJAID,
				TOPACTUALID, 
				ACCOUNTNO,  
				PAYEEACCOUNTNAME,
			    TIMEOFCOMMERCIALPAYMENT,
				TIMEOFCTPPAYMENT,
				ACCOUNTAMOUNT,
				CERTIFICATETYPE,
				CERTIFICATENO,
				PAYEETYPE,
				PROVINCEOFPAYEEACCOUNT,
				CITYOFPAYEEACCOUNT,
				NAMEOFBANK,
				NAMEOFHEADBANK,
				CTPACTUALAMOUNT,
				COMMERCIALACTUALAMOUNT,
				MEMO,
				CREATEDATE
                ,INCREASE_DATE --增量日期:20170515 ADD BY HB
			from AL_CF_RP_SETTLEMENTACCOUNT
			]]>     	                                              
		</transform>
		
		<!-- 20170210新增：同案多账号去重（根据TOPACTUALID,ACCOUNTNO分组后取每组第一条数据）-->
		<!-- 20170217新增：
						1、对于同案同账号只有一条记录的，ACCOUNTAMOUNT字段与jack_generateid_adjustment_amount（114行）表中的CLAIMAMOUNT字段值一致，案件号关联不上的则赋空
						2、对于同案同账号但有多条记录的，去重，随机保留一条；
							 ACCOUNTAMOUNT字段与jack_generateid_adjustment_amount（114行）表中的CLAIMAMOUNT字段值一致，案件号关联不上的则赋空
						3、对于同案多账号，如果同账号有多条记录，去重（最终保证同案同账号的记录数=1，同案多账号的，每个账号也只有一条记录）；
							 同案存在多个账号的，ACCOUNTAMOUNT字段直接赋空（因为jack_generateid_adjustment_amount表中没有账号信息） -->
		<!-- 第一步，先按案件号关联jack_generateid_adjustment_amount表 -->
		<transform table_name="jack_preprocessing_settlementaccount_2" type="sql" transform_mode="overwrite"  localpath="${PIPE_EXTERNAL_PATH}">
			<![CDATA[
			--先处理同案账号数等于1的情况，关联支付总额
			select
				dps1.DAJAID,
				dps1.TOPACTUALID, 
				dps1.ACCOUNTNO,  
				dps1.PAYEEACCOUNTNAME,
		        dps1.TIMEOFCOMMERCIALPAYMENT,
				dps1.TIMEOFCTPPAYMENT,
				dgaa.CLAIMAMOUNT as ACCOUNTAMOUNT,
				dps1.CERTIFICATETYPE,
				dps1.CERTIFICATENO,
				dps1.PAYEETYPE,
				dps1.PROVINCEOFPAYEEACCOUNT,
				dps1.CITYOFPAYEEACCOUNT,
				dps1.NAMEOFBANK,
				dps1.NAMEOFHEADBANK,
				dps1.CTPACTUALAMOUNT,
				dps1.COMMERCIALACTUALAMOUNT,
				dps1.MEMO,
				dps1.CREATEDATE
				--增量日期:20170515 ADD BY HB
                ,jack_max_date_udf(dps1.INCREASE_DATE, dgaa.INCREASE_DATE) AS INCREASE_DATE
			from jack_preprocessing_settlementaccount_1 dps1
			left join jack_generateid_adjustment_amount dgaa on dgaa.CASEFOLDERID = dps1.TOPACTUALID
			where dps1.TOPACTUALID in
			(
			  --筛选同案且账号数等于1的案件号
			  select TOPACTUALID
			  from jack_preprocessing_settlementaccount_1
			    group by TOPACTUALID having count(distinct ACCOUNTNO) = 1
			)
			
			union all

			--再处理同案且账号数大于1的情况
			select
				dps1.DAJAID,
				dps1.TOPACTUALID, 
				dps1.ACCOUNTNO,  
				dps1.PAYEEACCOUNTNAME,
		        dps1.TIMEOFCOMMERCIALPAYMENT,
				dps1.TIMEOFCTPPAYMENT,
				'' as ACCOUNTAMOUNT,
				dps1.CERTIFICATETYPE,
				dps1.CERTIFICATENO,
				dps1.PAYEETYPE,
				dps1.PROVINCEOFPAYEEACCOUNT,
				dps1.CITYOFPAYEEACCOUNT,
				dps1.NAMEOFBANK,
				dps1.NAMEOFHEADBANK,
				dps1.CTPACTUALAMOUNT,
				dps1.COMMERCIALACTUALAMOUNT,
				dps1.MEMO,
				dps1.CREATEDATE
                ,INCREASE_DATE --增量日期:20170515 ADD BY HB
			from jack_preprocessing_settlementaccount_1 dps1
			where dps1.TOPACTUALID in
			(
			  --筛选同案且账号数大于1的案件号
			  select TOPACTUALID
			  from jack_preprocessing_settlementaccount_1
			    group by TOPACTUALID having count(distinct ACCOUNTNO) > 1
			)
			]]>                             
		</transform>

		<!-- 第二步，按案件号和账号去重，保证同案同账号的记录数等于1 -->
		<transform table_name="jack_preprocessing_settlementaccount_3" type="sql" transform_mode="overwrite" localpath="./external">
			<![CDATA[
			  select
				dps2.DAJAID,
				dps2.TOPACTUALID, 
				dps2.ACCOUNTNO,  
				dps2.PAYEEACCOUNTNAME,
			    dps2.TIMEOFCOMMERCIALPAYMENT,
				dps2.TIMEOFCTPPAYMENT,
				dps2.ACCOUNTAMOUNT,
				dps2.CERTIFICATETYPE,
				dps2.CERTIFICATENO,
				dps2.PAYEETYPE,
				dps2.PROVINCEOFPAYEEACCOUNT,
				dps2.CITYOFPAYEEACCOUNT,
				dps2.NAMEOFBANK,
				dps2.NAMEOFHEADBANK,
				dps2.CTPACTUALAMOUNT,
				dps2.COMMERCIALACTUALAMOUNT,
				dps2.MEMO,
				dps2.CREATEDATE
                ,dps2.INCREASE_DATE --增量日期:20170515 ADD BY HB
		  from
          (
			  select
				  DAJAID,
				  TOPACTUALID, 
				  ACCOUNTNO,  
				  PAYEEACCOUNTNAME,
			      TIMEOFCOMMERCIALPAYMENT,
				  TIMEOFCTPPAYMENT,
				  ACCOUNTAMOUNT,
				  CERTIFICATETYPE,
				  CERTIFICATENO,
				  PAYEETYPE,
				  PROVINCEOFPAYEEACCOUNT,
				  CITYOFPAYEEACCOUNT,
				  NAMEOFBANK,
				  NAMEOFHEADBANK,
				  CTPACTUALAMOUNT,
				  COMMERCIALACTUALAMOUNT,
				  MEMO,
				  CREATEDATE,
                  INCREASE_DATE, --增量日期:20170515 ADD BY HB
				  row_number() over(partition by TOPACTUALID,ACCOUNTNO order by DAJAID) RN 
			  from jack_preprocessing_settlementaccount_2
			) dps2
			  where dps2.RN = 1
			]]>                               
		</transform>
		<!--
			变更 20170526：LJC
				新增对CERTIFICATETYPE、PAYEETYPE、PROVINCEOFPAYEEACCOUNT、CITYOFPAYEEACCOUNT字段中魔法数字的中文解释
		-->
	  <transform table_name="jack_generateid_settlementaccount" type="sql" >
			<![CDATA[
			select 
				distinct 
				s.DAJAID,
				s.TOPACTUALID, 
				s.ACCOUNTNO,  
				s.PAYEEACCOUNTNAME,
			   s.TIMEOFCOMMERCIALPAYMENT,
				s.TIMEOFCTPPAYMENT,
				s.ACCOUNTAMOUNT,
				s.CERTIFICATETYPE AS CERTIFICATETYPE_CODE,
				c1.DIM_NAME AS CERTIFICATETYPE,
				s.CERTIFICATENO,
				s.PAYEETYPE AS PAYEETYPE_CODE,
				c2.DIM_NAME AS PAYEETYPE,
				s.PROVINCEOFPAYEEACCOUNT AS PROVINCEOFPAYEEACCOUNT_CODE,
				c3.DIM_NAME AS PROVINCEOFPAYEEACCOUNT,
				s.CITYOFPAYEEACCOUNT AS CITYOFPAYEEACCOUNT_CODE,
				c4.DIM_NAME AS CITYOFPAYEEACCOUNT,
				s.NAMEOFBANK,
				s.NAMEOFHEADBANK,
				s.CTPACTUALAMOUNT,
				s.COMMERCIALACTUALAMOUNT,
				s.MEMO,
				s.CREATEDATE,
				'SETTLEMENT_ACCOUNT' as TYPE,
				0 as IS_DELETE,
				0 as IS_RANDOM
				--增量日期:20170515 ADD BY HB
				,jack_max_date_udf(s.INCREASE_DATE, c1.INCREASE_DATE, c2.INCREASE_DATE, c3.INCREASE_DATE, c4.INCREASE_DATE) AS INCREASE_DATE
			from jack_preprocessing_settlementaccount_3 s
			LEFT JOIN AL_CF_RP_DIM_CODE c1 ON c1.DIM_TYPE = 'CERTIFICATETYPE' and c1.DIM_CODE = s.CERTIFICATETYPE
			LEFT JOIN AL_CF_RP_DIM_CODE c2 ON c2.DIM_TYPE = 'PAYEETYPE' and c2.DIM_CODE = s.PAYEETYPE
			LEFT JOIN AL_CF_RP_DIM_CODE c3 ON c3.DIM_TYPE = 'PROVINCEOFPAYEEACCOUNT' and c3.DIM_CODE = s.PROVINCEOFPAYEEACCOUNT
			LEFT JOIN AL_CF_RP_DIM_CODE c4 ON c4.DIM_TYPE = 'CITYOFPAYEEACCOUNT' and c4.DIM_CODE = s.CITYOFPAYEEACCOUNT
			]]>     	                                              
		</transform>
		<!--******************************** 9.支付账号信息表 处理流程end *********************************-->
	</transforms>

	<sinks>
		<sink table_name="jack_generateid_case" type="parquet" savemode="overwrite" partitionby="INCREASE_DATE" path="${HDFS_BASE_PATH}/generateid/jack_generateid_case"  localpath="${PIPE_EXTERNAL_PATH}" />
		<sink table_name="jack_generateid_insurance" type="parquet" savemode="overwrite" partitionby="INCREASE_DATE" path="${HDFS_BASE_PATH}/generateid/jack_generateid_insurance"  localpath="${PIPE_EXTERNAL_PATH}" />
		<sink table_name="jack_generateid_vehicle" type="parquet" savemode="overwrite" partitionby="INCREASE_DATE" path="${HDFS_BASE_PATH}/generateid/jack_generateid_vehicle"  localpath="${PIPE_EXTERNAL_PATH}" />
		<sink table_name="jack_generateid_settlementaccount" type="parquet" savemode="overwrite" partitionby="INCREASE_DATE" path="${HDFS_BASE_PATH}/generateid/jack_generateid_settlementaccount"  localpath="${PIPE_EXTERNAL_PATH}" />
		<sink table_name="jack_generateid_person" type="parquet" savemode="overwrite" partitionby="INCREASE_DATE" path="${HDFS_BASE_PATH}/generateid/jack_generateid_person"  localpath="${PIPE_EXTERNAL_PATH}" />
		<!--<sink table_name="jack_generateid_valuablecase_no" type="parquet" savemode="overwrite" partitionby="INCREASE_DATE" path="${HDFS_BASE_PATH}/generateid/jack_generateid_valuablecase_no" localpath="${PIPE_EXTERNAL_PATH}" />-->
		<sink table_name="jack_generateid_valuablecase" type="parquet" savemode="overwrite" partitionby="INCREASE_DATE" path="${HDFS_BASE_PATH}/generateid/jack_generateid_valuablecase"  localpath="${PIPE_EXTERNAL_PATH}" />
		<sink table_name="jack_generateid_adjustment_amount" type="parquet" savemode="overwrite" partitionby="INCREASE_DATE" path="${HDFS_BASE_PATH}/generateid/jack_generateid_adjustment_amount"  localpath="${PIPE_EXTERNAL_PATH}" />
		<sink table_name="jack_generateid_adjustmentinfo" type="parquet" savemode="overwrite" partitionby="INCREASE_DATE" path="${HDFS_BASE_PATH}/generateid/jack_generateid_adjustmentinfo"  localpath="${PIPE_EXTERNAL_PATH}" />
	</sinks>
</configuration>
